---
title: "Clustering"
author: "Yanelli Nunez"
date: "8/13/2018"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("tidyverse")
library(tidyverse)
#install.packages("janitor")
library(janitor)
#install.packages("ggcorrplot")
library(ggcorrplot)
#install.packages("ggfortify")
library(ggfortify)
#install.packages("ggdendro")
library(ggdendro)
#install.packages("ggplotify")
library(ggplotify)
#install.packages("gridExtra")
library(gridExtra) 
#install.packages("knitr")
library(knitr)
#install.packages("dendextend")
library(dendextend)
#install.packages("pryr")
library(pryr)
```

## Data Import and Cleaning

```{r data preping}
studypop <- read_csv("./Data/studypop.csv") %>% 
  clean_names() %>% 
  na.omit()%>%
  mutate(bmi_cat3 = as.factor(bmi_cat3),
  edu_cat = as.factor(edu_cat),
  race_cat = as.factor(race_cat),
  male = as.factor(male))

#check dimensions of dataset
dim(studypop)

#summary statistics on dataset
summary(studypop)

#extract Non-dioxin-like PCB variables from the studypop data frame
my.x <- names(studypop)[grep("la", names(studypop))] 

#create a new data frame with my.x and convert values for the predictor variables to its natural log.
log.x <- data.frame(apply(studypop[,my.x], 2, FUN = function(x) log(x))) %>%
  setNames(paste(my.x, "l2", sep = ".")) %>% #add suffix 12 to the predictors' name
  na.omit() #remove missing

#check dimensions of dataset
dim(log.x)

#summary statistics on dataset
summary(log.x)
```

## K-Means Clustering

```{r k-means}
# for reproducibility, set seed
set.seed(28)


#K-menas with K = 1
km1 <- kmeans(log.x, 1, nstart = 20)

summary(km1$size)
head(km1$centers)
km1$totss ## total sum of squares
km1$withinss ## within cluster sum of squares by cluster
km1$tot.withinss ## total within cluster sum of squares -- this is what we want to minimize!
km1$betweenss ## between cluster sum of squares
Percent_bt_k1 = paste(round(100*(km1$betweenss/km1$totss),1), "%", sep = "")


#K-means with K = 2
km2 <- kmeans(log.x, 2, nstart = 20) 
km2
km2$cluster
km2$size
km2$centers
km2$totss 
km2$withinss
km2$tot.withinss 
km2$betweenss 
Percent_bt_k2 = paste(round(100*(km2$betweenss/km2$totss),1), "%", sep = "")

#K-means with K = 3
km3 <- kmeans(log.x, 3, nstart = 20)

km3$size
km3$centers
km3$totss 
km3$withinss 
km3$tot.withinss  
km3$betweenss 
Percent_bt_k3 = paste(round(100*(km3$betweenss/km3$totss),1), "%", sep = "")

#K-means with K = 10
km10 <- kmeans(log.x, 10, nstart = 20)

km10$size
km10$centers
km10$totss 
km10$withinss 
km10$tot.withinss  
km10$betweenss 
Percent_bt_k10 = paste(round(100*(km10$betweenss/km10$totss),1), "%", sep = "")

#K-means with K = 100
km100 <- kmeans(log.x, 100, nstart = 20)

km100$size
head(km100$centers)
km100$totss 
km100$withinss 
km100$tot.withinss  
km100$betweenss 
Percent_bt_k100 = paste(round(100*(km100$betweenss/km100$totss),1), "%", sep = "")


```

### Summary Table 

```{r summary}
summary.km <- matrix(c(km1$totss, km2$totss, km3$totss, km10$totss, km100$totss, 
                       km1$tot.withinss, km2$tot.withinss, km3$tot.withinss, km10$tot.withinss, km100$tot.withinss, 
                       km1$betweenss, km2$betweenss, km3$betweenss, km10$betweenss, km100$betweenss), 
                     ncol = 3)
colnames(summary.km) <- c("Total SS", "Total within cluster SS", "Between cluster SS")
rownames(summary.km) <- c("km-1", "km-2", "km-3", "km-10", "km-100")
summary.km <- round(as.table(summary.km), 2) 
summary.km <- kable(summary.km)
summary.km
```

### Health model 

#### 2 Cluster Model

Combine clusters grouping with original data outcome and covariants for K-means = 2

```{r}
clu.group <- km2$cluster #cluster group

pop <- read_csv("./Data/studypop.csv") %>% 
  clean_names() %>% 
  na.omit() %>%
  dplyr::select(-(3:10), -(17:26)) %>% 
  mutate(logtelomean = log(telomean))

pop_clus <- as.tibble((cbind(pop, clu.group)))
table(pop_clus$clu.group)
```

```{r}
health_model_kmeans <- lm(logtelomean ~ as.factor(clu.group) +
     lbxwbcsi + lbxlypct + lbxmopct + lbxnepct + lbxeopct + lbxbapct +
     as.factor(bmi_cat3) + as.factor(edu_cat) + as.factor(race_cat) + male, data = pop_clus)

health_model_kmeans %>% broom::tidy() %>% mutate(
  estimate = round(estimate, 4),
  std.error = round(std.error, 4),
  statistic = round(statistic, 4),
  p.value = round(p.value, 4))

health_model_kmeans %>% broom::glance() %>% mutate(p.value = round(p.value, 5))
```

##### Plot

```{r}
health_model_kmeans %>% broom::tidy() %>% as.tibble() %>% filter(grepl("clu.group", term)) %>% 
  mutate(term = ifelse(term == "as.factor(clu.group)2", "Cluster 2", "")) %>% 
  ggplot(aes(x = term, y = estimate, color = term,
             ymin = estimate - 1.96*std.error,
             ymax = estimate + 1.96*std.error)) +
  geom_pointrange() + theme_bw() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  theme(legend.position = "none") + coord_flip() +
  labs(y = "Estimate", x = "Factor", title = "Association between Clusters and LTL")
```

#### 3 Cluster Model

Combine clusters grouping with original data outcome and covariants for K-means = 2

```{r}
clu.group3 <- km3$cluster #cluster group

pop_clus3 <- as.tibble((cbind(pop, clu.group3)))
table(pop_clus3$clu.group3)
```

```{r}
health_model_kmeans3 <- lm(logtelomean ~ as.factor(clu.group3) +
     lbxwbcsi + lbxlypct + lbxmopct + lbxnepct + lbxeopct + lbxbapct +
     as.factor(bmi_cat3) + as.factor(edu_cat) + as.factor(race_cat) + male, data = pop_clus3)

health_model_kmeans3 %>% broom::tidy() %>% mutate(
  estimate = round(estimate, 4),
  std.error = round(std.error, 4),
  statistic = round(statistic, 4),
  p.value = round(p.value, 4))

health_model_kmeans %>% broom::glance() %>% mutate(p.value = round(p.value, 5))
```

##### Plot

```{r}
health_model_kmeans3 %>% broom::tidy() %>% as.tibble() %>% filter(grepl("clu.group", term)) %>% 
  mutate(term = ifelse(term == "as.factor(clu.group3)2", "Cluster 2", "Cluster 3")) %>% 
  ggplot(aes(x = term, y = estimate, color = term,
             ymin = estimate - 1.96*std.error,
             ymax = estimate + 1.96*std.error)) +
  geom_pointrange() + theme_bw() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  theme(legend.position = "none") + coord_flip() +
  labs(y = "Estimate", x = "Factor", title = "Association between Clusters and LTL")
```

#### 10 Cluster Model

Combine clusters grouping with original data outcome and covariants for K-means = 2

```{r}
clu.group10 <- km10$cluster #cluster group

pop_clus10 <- as.tibble((cbind(pop, clu.group10)))
table(pop_clus10$clu.group10)
```

```{r}
health_model_kmeans10 <- lm(logtelomean ~ as.factor(clu.group10) +
     lbxwbcsi + lbxlypct + lbxmopct + lbxnepct + lbxeopct + lbxbapct +
     as.factor(bmi_cat3) + as.factor(edu_cat) + as.factor(race_cat) + male, data = pop_clus10)

health_model_kmeans10 %>% broom::tidy() %>% mutate(
  estimate = round(estimate, 4),
  std.error = round(std.error, 4),
  statistic = round(statistic, 4),
  p.value = round(p.value, 4))

health_model_kmeans %>% broom::glance() %>% mutate(p.value = round(p.value, 5))
```

##### Plot

```{r}
health_model_kmeans10 %>% broom::tidy() %>% as.tibble() %>% filter(grepl("clu.group", term)) %>% 
  mutate(term = ifelse(term == "as.factor(clu.group10)2", "Cluster 2", 
                 ifelse(term == "as.factor(clu.group10)3", "Cluster 3",
                  ifelse(term == "as.factor(clu.group10)4", "Cluster 4",
                   ifelse(term == "as.factor(clu.group10)5", "Cluster 5",
                    ifelse(term == "as.factor(clu.group10)6", "Cluster 6",
                     ifelse(term == "as.factor(clu.group10)7", "Cluster 7",
                      ifelse(term == "as.factor(clu.group10)8", "Cluster 8", 
                       ifelse(term == "as.factor(clu.group10)9", "Cluster 9", "Cluster 10"))))))))) %>%
  ggplot(aes(x = term, y = estimate, color = term,
             ymin = estimate - 1.96*std.error,
             ymax = estimate + 1.96*std.error)) +
  geom_pointrange() + theme_bw() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  theme(legend.position = "none") + coord_flip() +
  labs(y = "Estimate", x = "Factor", title = "Association between Clusters and LTL")
```

## Hierarchical Clustering

```{r h clustering}
# Hierarchical clustering analysis
hc.complete <- hclust(dist(na.omit(log.x)), method = "complete")
hc.average  <- hclust(dist(na.omit(log.x)), method = "average")
hc.single   <- hclust(dist(na.omit(log.x)), method = "single")

#summary of outcome for each method
as.dendrogram(hc.complete) %>% head()
as.dendrogram(hc.average) %>% head()
as.dendrogram(hc.single) %>% head()
```

### Dendrograms

```{r dendrograms}

dend.complete <- dendro_data(hc.complete, type = "rectangle")
plot.complete <- ggplot(segment(dend.complete)) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend), alpha = 0.5) +
  labs(y = "Height", x = "", title = "Complete Linkage") + theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), 
        panel.grid = element_blank())

dend.average <- dendro_data(hc.average, type = "rectangle")
plot.average <- ggplot(segment(dend.average)) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend), alpha = 0.5) +
  labs(y = "", x = "", title = "Average Linkage") + theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        panel.grid = element_blank())

dend.single <- dendro_data(hc.single, type = "rectangle")
plot.single <- ggplot(segment(dend.single)) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend), alpha = 0.5) +
  labs(y = "", x = "", title = "Single Linkage") + theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        panel.grid = element_blank())

grid.arrange(plot.complete, plot.average, plot.single, ncol = 3)
```

### Cut Trees at Different Heights

```{r cutting trees}

dendro.complete <- as.dendrogram(hc.complete)

par(mfrow = c(1,2))

#cut tree at a height of 12 resulting in 2 clusters
dendro.complete %>% 
  color_branches(k = 2) %>%
  plot(main = "Complete Linkage", ylab = "Height", leaflab = "none") 
abline(h = 12, lty = 3)

#cut tree at a height of 11.25 resulting in 3 clusters
dendro.complete %>% color_branches(k = 3) %>% 
    plot(ylab = "Height", leaflab = "none")
  abline(h = 11.25, lty = 3)
  
#cut tree at a height of 10 resulting in 4 clusters
dendro.complete %>% 
  color_branches(k = 4) %>%
  plot(ylab = "Height", leaflab = "none") 
abline(h = 10, lty = 3)
```

### Health Models

#### 2 Cluster Model

Combine clusters grouping with original data outcome and covariants for K-means = 2

```{r}
clu.group10 <- km10$cluster #cluster group

pop_clus10 <- as.tibble((cbind(pop, clu.group10)))
table(pop_clus10$clu.group10)
```

```{r}
health_model_kmeans10 <- lm(logtelomean ~ as.factor(clu.group10) +
     lbxwbcsi + lbxlypct + lbxmopct + lbxnepct + lbxeopct + lbxbapct +
     as.factor(bmi_cat3) + as.factor(edu_cat) + as.factor(race_cat) + male, data = pop_clus10)

health_model_kmeans10 %>% broom::tidy() %>% mutate(
  estimate = round(estimate, 4),
  std.error = round(std.error, 4),
  statistic = round(statistic, 4),
  p.value = round(p.value, 4))

health_model_kmeans %>% broom::glance() %>% mutate(p.value = round(p.value, 5))
```

##### Plot

```{r}
health_model_kmeans10 %>% broom::tidy() %>% as.tibble() %>% filter(grepl("clu.group", term)) %>% 
  mutate(term = ifelse(term == "as.factor(clu.group10)2", "Cluster 2", 
                 ifelse(term == "as.factor(clu.group10)3", "Cluster 3",
                  ifelse(term == "as.factor(clu.group10)4", "Cluster 4",
                   ifelse(term == "as.factor(clu.group10)5", "Cluster 5",
                    ifelse(term == "as.factor(clu.group10)6", "Cluster 6",
                     ifelse(term == "as.factor(clu.group10)7", "Cluster 7",
                      ifelse(term == "as.factor(clu.group10)8", "Cluster 8", 
                       ifelse(term == "as.factor(clu.group10)9", "Cluster 9", "Cluster 10"))))))))) %>%
  ggplot(aes(x = term, y = estimate, color = term,
             ymin = estimate - 1.96*std.error,
             ymax = estimate + 1.96*std.error)) +
  geom_pointrange() + theme_bw() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  theme(legend.position = "none") + coord_flip() +
  labs(y = "Estimate", x = "Factor", title = "Association between Clusters and LTL")
```

