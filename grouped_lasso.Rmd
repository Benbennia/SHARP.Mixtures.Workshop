---
title: 'Mixtures Workshop: Grouped Lasso'
author: "Lizzy Gibson"
date: "July 18, 2018"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("tidyverse")
library(tidyverse)
#install.packages("grpreg")
library(grpreg)
#install.packages("splines")
library(splines)
#install.packages("refund")
library(refund)
#install.packages("refund.shiny")
library(refund.shiny)
#install.packages("janitor")
library(janitor)

#This turns off scientific notation
options(scipen = 999)
```

## Data

```{r clean}
data(Birthwt)
studypop <- read_csv("./Data/studypop.csv") %>% clean_names() %>% 
  mutate(bmi_cat3 = as.factor(bmi_cat3),
  edu_cat = as.factor(edu_cat),
  race_cat = as.factor(race_cat),
  male = as.factor(male)) %>% 
  dplyr::select(-seqn)

#Group lasso wants data SEPARATE, with y value as one vector, X as a matrix of predictors (numeric values, categorical variables must be changed to 0/1 dummy variables), and grouping variable as a factor vector.

#Create X matrix with SCALED continuous variables (PCBs, Dioxins, and Furans) and dummy variables for categorical.
x <- model.matrix(telomean ~ ., studypop)[,-1]
#x[,1:24] <- scale(x[,1:24])
#grpreg standardizes the data, so we don't need to
#These are complete cases

#y is the outcome variable
y <- na.omit(studypop)$telomean

#Create grouping variable two ways. Blood cell count distribution variables always grouped together. Dummy variables for categorical variables always grouped together. Group must be a FACTOR. 

# (1) 3 groups = 8 non-Dioxin-like PCBs, 2 non-ortho PCBs, and TEQ (3 dioxins, 4 furans, 1 mono-ortho (Dioxin-like) PCBs). 
group3 <- vector()
group3[grepl("lbx1|0",colnames(x))] <- "Non-Dioxin-like PCB"
group3[grepl("lbxd", colnames(x))] <- "TEQ"
group3[grepl("lbxf", colnames(x))] <- "TEQ"
group3[grepl("lbxh|p", colnames(x))] <- "Non-Ortho PCB"
group3[grepl("lbx118la", colnames(x))] <- "TEQ"
group3[grepl("pct", colnames(x))] <- "Blood Cells"
group3[grepl("bcsi", colnames(x))] <- "Blood Cells"
group3[grepl("bmi", colnames(x))] <- "BMI"
group3[grepl("edu", colnames(x))] <- "EDU"
group3[grepl("race", colnames(x))] <- "Race"
group3[grepl("male", colnames(x))] <- "Male"
group3[grepl("bxcot", colnames(x))] <- "Cotinine"
group3[grepl("age", colnames(x))] <- "Age"

cbind(colnames(x), group3)

# (2) 4 groups = 8 non-dioxin-like PCBs, 3 non-ortho PCBs, 3 dioxins, and 4 furans.

group4 <- vector()
group4[grepl("lbx1|0",colnames(x))] <- "Non-Dioxin-like PCB"
group4[grepl("lbxd", colnames(x))] <- "Dioxin"
group4[grepl("lbxf", colnames(x))] <- "Furan"
group4[grepl("lbxh|p", colnames(x))] <- "Non-Ortho PCB"
group4[grepl("lbx118la", colnames(x))] <- "Non-Ortho PCB"
group4[grepl("pct", colnames(x))] <- "Blood Cells"
group4[grepl("bcsi", colnames(x))] <- "Blood Cells"
group4[grepl("bmi", colnames(x))] <- "BMI"
group4[grepl("edu", colnames(x))] <- "EDU"
group4[grepl("race", colnames(x))] <- "Race"
group4[grepl("male", colnames(x))] <- "Male"
group4[grepl("bxcot", colnames(x))] <- "Cotinine"
group4[grepl("age", colnames(x))] <- "Age"

cbind(colnames(x), group4)
```

## Group Lasso

```{r models}
lasso_3 <- grpreg(x, y, group3, penalty = "grLasso", 
                  penalty.factor = c(rep(1, 24), rep(0, 12)))

MCP_3 <- grpreg(x, y, group3, penalty = "grMCP")
SCAD_3 <- grpreg(x, y, group3, penalty = "grSCAD")

par(mfrow = c(1,3))
plot(lasso_3)
plot(MCP_3)
plot(SCAD_3)

lasso_4 <- grpreg(x, y, group4, penalty = "grLasso")
MCP_4 <- grpreg(x, y, group4, penalty = "grMCP")
SCAD_4 <- grpreg(x, y, group4, penalty = "grSCAD")

par(mfrow = c(1,3))
plot(lasso_4)
plot(MCP_4)
plot(SCAD_4)
```

## Cross Validation

```{r cv}
#Cross-validation to choose the tuning parameter lambda, ten-fold default
cv_lasso_3 <- cv.grpreg(x, y, group3, penalty = "grLasso", seed = 1988, 
                  penalty.factor = c(rep(1, 24), rep(0, 12)))

best_lam_lasso_3 <- cv_lasso_3$lambda.min
#This is the lambda that results in the smallest cross-validation error

#Fit model with cross-validated lambda
fit_lasso_3 <- grpreg(x, y, group3, penalty = "grLasso", 
                      lambda = best_lam_lasso_3, 
                  penalty.factor = c(rep(1, 24), rep(0, 12)))
fit_lasso_3$beta
```

## Estimate Test Error

### Training Set

```{r train}
#Create training and test sets
set.seed(1988)
train <- sample(1:nrow(x), nrow(x)/2)
test <- (-train)

#Fit model on training set
cv_lasso_3_train <- cv.grpreg(x[train,], y[train], group3, 
                              penalty = "grLasso", seed = 1988)

best_lam_lasso_3_train <- cv_lasso_3_train$lambda.min
#This is the lambda that results in the smallest cross-validation error in the TRAINING set


#Fit model with cross-validated lambda
fit_lasso_3_train <- grpreg(x[train,], y[train], 
                            group3, penalty = "grLasso", 
                            lambda = best_lam_lasso_3_train)

#MSE in test set
lasso_3_p <- predict(fit_lasso_3_train,
                        X = x[train,])

mean((lasso_3_p - y[train])^2)
```

### Test Set

```{r test}
#MSE in test set
lasso_3_pred <- predict(fit_lasso_3_train,
                        X = x[test,])

mean((lasso_3_pred - y[test])^2)
```

## Data Viz

```{r viz}
lasso_beta <- cbind(rownames(fit_lasso_3$beta), fit_lasso_3$beta) %>% as.tibble() %>% 
  rename(variable = V1, beta = `0.0058`) %>% 
  mutate(beta = as.numeric(beta)) %>% filter(variable != "(Intercept)") %>% 
  mutate(group3 = group3,
         group4 = group4)

#Filter out covariates
lasso_beta %>% filter(group3 %in% c("TEQ", "Non-Dioxin-like PCB", "Non-Ortho PCB")) %>% 
  ggplot(aes(x = variable, 
                       y = round(beta, 5))) + geom_point() +
  theme_minimal() + geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  facet_wrap(.~group3, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() + 
  labs(title = "Lasso Coefficients for 3 Group Model", y = "Beta Coefficient",
       x = "Variable")


lasso_beta %>% filter(group3 %in% c("TEQ", "Non-Dioxin-like PCB", "Non-Ortho PCB")) %>%
  ggplot(aes(x = variable, 
                       y = round(beta, 5))) + geom_point() +
  theme_minimal() + geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  facet_wrap(.~group4, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() + 
  labs(title = "Lasso Coefficients for 4 Group Model", y = "Beta Coefficient",
       x = "Variable")
```

